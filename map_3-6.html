<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <title>台北飲料店地圖</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map {
            height: 80vh;
        }
        #legend {
            margin-top: 10px;
            padding: 5px;
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.4);
        }
        #legend h3 {
            margin: 0 0 5px;
            font-size: 14px;
        }
        #legend ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #legend ul li {
            margin-bottom: 5px;
            display: flex;
            align-items: center;
        }
        #legend ul li .color-box {
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }
        #legend ul li span {
            font-size: 12px;
        }
    </style>
</head>

<body>
    <h2>台北飲料店地圖</h2>
    <label for="day-select">選擇日期:</label>
    <select id="day-select">
        <option value="wednesday-saturday">週三減週六</option>
    </select>
    <label for="time-select">選擇時間:</label>
    <input type="range" id="time-select" min="6" max="23" step="1" value="6">
    <span id="time-display">6:00</span>
    <div id="map"></div>
    <div id="legend">
        <h3>圖例</h3>
        <ul>
            <li>
                <div class="color-box" style="background-color: rgb(255, 255, 255);"></div><span>繁忙程度差異為 0%</span>
            </li>
            <li>
                <div class="color-box" style="background-color: rgb(204, 204, 204);"></div><span>繁忙程度差異為 ±20%</span>
            </li>
            <li>
                <div class="color-box" style="background-color: rgb(153, 153, 153);"></div><span>繁忙程度差異為 ±40%</span>
            </li>
            <li>
                <div class="color-box" style="background-color: rgb(102, 102, 102);"></div><span>繁忙程度差異為 ±60%</span>
            </li>
            <li>
                <div class="color-box" style="background-color: rgb(51, 51, 51);"></div><span>繁忙程度差異為 ±80%</span>
            </li>
        </ul>
    </div>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="all.js"></script>
    <script>
    console.log("Checking if all.js is loaded...");
    console.log(milkshopData);
    </script>
    <script>
    document.getElementById('time-select').addEventListener('input', function() {
        document.getElementById('time-display').innerText = this.value + ":00";
        updateMap();
    });

    // 初始化地圖
    var map = L.map('map').setView([25.0330, 121.5654], 12);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
    }).addTo(map);


    var markers = [];

    function updateMap() {
        var hour = parseInt(document.getElementById('time-select').value);

        markers.forEach(marker => map.removeLayer(marker));
        markers = [];

        milkshopData.forEach(function(d) {
            var show = (hour >= parseInt(d.milkshop_time_mor) && hour < parseInt(d.milkshop_time_nig));
            if (show) {
                var color = getColor(hour, d);
                if (color !== null) {
                    var marker = L.circleMarker([d.milk_lati, d.milk_longi], {
                        radius: 8,
                        fillColor: color,
                        color: color,
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);

                    marker.on('mouseover', function(e) {
                        var popupContent = `<b>店名:</b> ${d.milkshop_name}<br>
                                                <b>營業時間:</b> ${d.milkshop_time}<br>
                                                <b>繁忙程度差異:</b> ${getBusyDifference(hour, d)}`;
                        var popup = L.popup()
                            .setLatLng(e.latlng)
                            .setContent(popupContent)
                            .openOn(map);
                    });

                    marker.on('mouseout', function() {
                        map.closePopup();
                    });

                    markers.push(marker);
                }
            }
        });
    }

    function getColor(hour, d) {
        var wednesdayColumns = ['six', 'seven', 'eight', 'nine', 'ten', 'eleven', 'twelve', 'thirteen', 'fourteen', 'fifteen', 'sixteen', 'seventeen', 'eighteen', 'nineteen', 'twenty', 'twenty_one', 'twenty_two', 'twenty_three'];
        var saturdayColumns = ['s_six', 's_seven', 's_eight', 's_nine', 's_ten', 's_eleven', 's_twelve', 's_thirteen', 's_fourteen', 's_fifteen', 's_sixteen', 's_seventeen', 's_eighteen', 's_nineteen', 's_twenty', 's_twenty_one', 's_twenty_two', 's_twenty_three'];

        var wednesdayValue = d[wednesdayColumns[hour - 6]];
        var saturdayValue = d[saturdayColumns[hour - 6]];

        if (wednesdayValue === -1 || saturdayValue === -1) {
            return null; // 如果任一值為-1，則不顯示
        }

        var difference = wednesdayValue - saturdayValue;
        var grayscale = 255 - (Math.abs(difference) * 2.55); // 0~100轉換為0~255
        return `rgb(${grayscale}, ${grayscale}, ${grayscale})`;
    }

    function getBusyDifference(hour, d) {
        var wednesdayColumns = ['six', 'seven', 'eight', 'nine', 'ten', 'eleven', 'twelve', 'thirteen', 'fourteen', 'fifteen', 'sixteen', 'seventeen', 'eighteen', 'nineteen', 'twenty', 'twenty_one', 'twenty_two', 'twenty_three'];
        var saturdayColumns = ['s_six', 's_seven', 's_eight', 's_nine', 's_ten', 's_eleven', 's_twelve', 's_thirteen', 's_fourteen', 's_fifteen', 's_sixteen', 's_seventeen', 's_eighteen', 's_nineteen', 's_twenty', 's_twenty_one', 's_twenty_two', 's_twenty_three'];

        var wednesdayValue = d[wednesdayColumns[hour - 6]];
        var saturdayValue = d[saturdayColumns[hour - 6]];

        if (wednesdayValue === -1 || saturdayValue === -1) {
            return 'N/A'; // 如果任一值為-1，則顯示N/A
        }

        var difference = wednesdayValue - saturdayValue;
        return difference + '%';
    }

    updateMap();
    </script>
</body>

</html>